<!DOCTYPE html>
<html>
<head>
	<title>Radunfälle Gütersloh 2015</title>
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link type="text/css" rel="stylesheet" href="leaflet.css">
	<link type="text/css" rel="stylesheet" href="MarkerCluster.css">
	<link type="text/css" rel="stylesheet" href="MarkerCluster.Default.css">
	<link type="text/css" rel="stylesheet" href="leaflet.awesome-markers.css">
	<link type="text/css" rel="stylesheet" href="font-awesome/css/font-awesome.min.css">

	<script src="leaflet.js"></script>
	<script src="leaflet.markercluster.js"></script>
	<script src="leaflet.awesome-markers.min.js"></script>
	<script src="leaflet.ajax.min.js"></script>
	<script src="unfalltypen.js"></script>
	<script src="unfallursache.js"></script>

	<script src="data/unfalldaten.json"></script>
	<script src="data/wheretozoom.js"></script>
	<style>
		body { padding: 0; margin 0; }
		html, body, #mapid { height: 100%;, width: 100%; }
	</style>
</head>

<body>
	<div id="mapid"</div>
	<script>

function verkehrsbeteiligter(v) {
	/* Verursacher */
	var vs="Sonstige";
	if (v < 71) {
		vs="KFZ";
	} else if (v == 71 || v == 72) {
		vs="Fahrrad";
	} else if (v == 81) {
		vs="Fußgänger";
	}
	return vs + " (" + v + ")";
}
function styleperspeed(feature) {
	if (feature.properties.highway === 'living_street' ||
		 	feature.properties.highway === 'pedestrian') {
		return {color: "#008000"};
	}

	var maxspeed=Number(feature.properties.maxspeed);
	if (maxspeed > 50) {
		return {color: "#ff0000"};
	} else if (maxspeed > 30) {
		return {color: "#ffff00"};
	} else if (maxspeed > 10) {
		return {color: "#00ff00"};
	}
	return {};
}

		var deadmarker = L.AwesomeMarkers.icon({
					icon: 'close',
					prefix: 'fa',
					markerColor: 'red'
		});

		var redmarker = L.AwesomeMarkers.icon({
					markerColor: 'red'
		});

		var bluemarker = L.AwesomeMarkers.icon({
					markerColor: 'blue'
		});

		var orangemarker = L.AwesomeMarkers.icon({
					markerColor: 'orange'
		});


		var map=L.map('mapid');

		/* Region specific function from data subdir */
		wheretozoom(map);

		var colourlayer=L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			maxZoom: 18,
			attribution: 'Map data © <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',
			id: 'colour'
		}).addTo(map);

		var bwlayer=L.tileLayer('http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
			maxZoom: 18,
			attribution: 'Map data © <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',
			id: 'greyscale'
		});


		var boundary = L.geoJson.ajax("data/boundary.geojson",
				{
					style: {
							"color": "#ff0080",
							"fillOpacity": 0
					}
				});
		map.addLayer(boundary);

		var maxspeed = L.geoJson.ajax("data/maxspeed.geojson",
				{
					style: styleperspeed
				});

		var cluster = L.markerClusterGroup();
		var marker = L.layerGroup();

		for(var i in data) {
			var d=data[i];

			/* Create unfalltype */
			var typ=d.typ;
			var utyp=d.utyp;

			if (utyp < 10) {
					utyp="0" + utyp;
			}
			var type=typ + utyp;

			var icon=bluemarker;
			if (d.gt != 0) {
				icon=deadmarker;
			} else if (d.sv != 0) {
				icon=redmarker;
			} else if (d.lv != 0) {
				icon=orangemarker;
			}

			var m=L.marker(new L.LatLng(data[i].geoy, data[i].geox),
					{ icon: icon, title: d.datum + " " + d.zeit });

			/* Create unfalltype image link */
			var timage="<img src=\"images/unka/" + type + ".png\">";

			var ort=d.strasse1;
			if (d.strasse2) {
					ort=ort + " / " + d.strasse2;
			}

			var ut=unfalltypen[type];
			var uts="";
			if (ut) {
				if (ut.beschreibung) {
					uts=uts+"<br>Beschreibung: " + ut.beschreibung;
				}
				if (ut.ort) {
					uts=uts+"<br>Ort: " + ut.ort;
				}
				if (ut.kommentar) {
					uts=uts+"<br>Kommentar: " + ut.kommentar;
				}
			}

			var ursache=unfallursache[d.u101];

			/* Create popup with HTML code */
			var p=d.tag + " " + d.datum + " " + d.zeit + "Uhr<br>"
					+ "Ursache: " + ursache + "<br>"
					+ "<table><tr><td>" + timage + "</td><td>" + uts + "</td></tr></table><br>"
					+ ort;

			if (d.gt != 0) {
				p=p + "<br>" + d.gt + " Getötete(r)";
			}
			if (d.sv != 0) {
				p=p + "<br>" + d.sv + " Schwerletzte(r)";
			}
			if (d.lv != 0) {
				p=p + "<br>" + d.lv + " Leichtverletzte(r)";
			}

			p=p + "<br><br>Anzahl Beteiligte: " + d.bet + "<br>Hauptverursacher: " + verkehrsbeteiligter(Number(d.vb01));
			if (d.vb02) {
				p=p + "<br>Beteiligter: " + verkehrsbeteiligter(Number(d.vb02));
			}

			m.bindPopup(p)

			cluster.addLayer(m);
			marker.addLayer(m);
		}
		map.addLayer(cluster);

		L.control.layers(
					{
							"OpenStreetmap": colourlayer,
							"Greyscale": bwlayer
					},
					{
							"Cluster": cluster,
							"Marker": marker,
							"Maxspeed": maxspeed,
							"Stadtgrenze": boundary
					}).addTo(map);

	</script>
</body>
</html>

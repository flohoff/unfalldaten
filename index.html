<!DOCTYPE html>
<html>
<head>
	<title>Loading data ...</title>
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link type="text/css" rel="stylesheet" href="leaflet.css">
	<link type="text/css" rel="stylesheet" href="MarkerCluster.css">
	<link type="text/css" rel="stylesheet" href="MarkerCluster.Default.css">
	<link type="text/css" rel="stylesheet" href="leaflet.awesome-markers.css">
	<link type="text/css" rel="stylesheet" href="font-awesome/css/font-awesome.min.css">

	<script src="leaflet.js"></script>
	<script src="leaflet.markercluster.js"></script>
	<script src="leaflet.awesome-markers.min.js"></script>
	<script src="leaflet.ajax.min.js"></script>
	<script src="unfalltypen.js"></script>
	<script src="unfallursache.js"></script>

	<script src="data/unfalldaten.json"></script>
	<script src="data/wheretozoom.js"></script>
	<script src="data/settitle.js"></script>
	<style>
		body { padding: 0; margin 0; }
		html, body, #mapid { height: 100%;, width: 100%; }
	</style>
</head>

<body>
	<div id="mapid"</div>
	<script>

function fahrradbeteiligt(d) {
	var v=Number(d.vb01);
	if (v == 71 || v == 72)
		return true;
	v=Number(d.vb02);
	if (v == 71 || v == 72)
		return true;
	return false;
}

function verkehrsbeteiligter(v) {
	/* Verursacher */
	var vs="Sonstige";
	if (v < 71) {
		vs="KFZ";
	} else if (v == 71 || v == 72) {
		vs="Fahrrad";
	} else if (v == 81) {
		vs="Fußgänger";
	}
	return vs + " (" + v + ")";
}
function styleperspeed(feature) {
	if (feature.properties.highway === 'living_street' ||
		 	feature.properties.highway === 'pedestrian') {
		return {color: "#008000"};
	}

	var maxspeed=Number(feature.properties.maxspeed);
	if (maxspeed > 50) {
		return {color: "#ff0000"};
	} else if (maxspeed > 30) {
		return {color: "#ffff00"};
	} else if (maxspeed > 10) {
		return {color: "#00ff00"};
	}
	return {};
}

function addgeojsonpopup(feature, layer) {
	if (feature.properties && feature.properties.popupContent) {
		layer.bindPopup(feature.properties.popupContent);
	}
}
		//L.AwesomeMarkers.Icon.prototype.options.prefix = 'fa';

		var markericons = {
			normal: {
				green: L.AwesomeMarkers.icon({ markerColor: 'green' }),
				red: L.AwesomeMarkers.icon({ markerColor: 'red' }),
				orange: L.AwesomeMarkers.icon({ markerColor: 'orange' }),
				blue: L.AwesomeMarkers.icon({ markerColor: 'blue' })
			},
			bike: {
				green: L.AwesomeMarkers.icon({ markerColor: 'green', prefix: 'fa', icon: 'bicycle' }),
				red: L.AwesomeMarkers.icon({ markerColor: 'red', prefix: 'fa', icon: 'bicycle' }),
				orange: L.AwesomeMarkers.icon({ markerColor: 'orange', prefix: 'fa', icon: 'bicycle' }),
				blue: L.AwesomeMarkers.icon({ markerColor: 'blue', prefix: 'fa', icon: 'bicycle' }),
			}
		};

		var map=L.map('mapid');

		/* Region specific function from data subdir */
		wheretozoom(map);
		settitle(map);

		var colourlayer=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			maxZoom: 18,
			attribution: 'Map data © <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',
			id: 'colour'
		}).addTo(map);

		var bwlayer=L.tileLayer('http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
			maxZoom: 18,
			attribution: 'Map data © <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',
			id: 'greyscale'
		});

		L.control.scale({ imperial: false }).addTo(map);

		var boundary = L.geoJson.ajax("data/boundary.geojson",
				{
					style: {
							"color": "#ff0080",
							"fillOpacity": 0
					}
				});
		map.addLayer(boundary);

		var kita = L.geoJson.ajax("data/kita.geojson",
				{
					onEachFeature: addgeojsonpopup,
					style: {
							"color": "#a03030",
							"opacity": 0.3,
							"fillOpacity": 0.3
					}
				});

		var kitabuffer = L.geoJson.ajax("data/kitabuffer.geojson",
				{
					onEachFeature: addgeojsonpopup,
					style: {
							"color": "#a05030",
							"opacity": 0.3,
							"fillOpacity": 0.2
					}
				});

		var maxspeed = L.geoJson.ajax("data/maxspeed.geojson",
				{
					style: styleperspeed
				});

		var cluster = L.markerClusterGroup();
		var marker = L.layerGroup();

		for(var i in data) {
			var d=data[i];

			/* Create unfalltype */
			var typ=d.typ;
			var utyp=d.utyp;

			if (utyp < 10) {
					utyp="0" + utyp;
			}

			// 2017 has utyp containing the full unka
			var type=typ + utyp;
			if (utyp > 100) {
				type=utyp
			}

			var icon="green";
			if (d.gt != 0) {
				icon="red";
			} else if (d.sv != 0) {
				icon="orange";
			} else if (d.lv != 0) {
				icon="blue";
			}

			var icontype="normal";
			if (fahrradbeteiligt(d)) {
				icontype="bike";
			}

			var m=L.marker(new L.LatLng(data[i].geoy, data[i].geox),
					{ icon: markericons[icontype][icon], title: d.datum + " " + d.zeit });

			/* Create unfalltype image link */
			var timage="<img src=\"images/unka/" + utyp + ".png\">";

			var ort=d.strasse1;
			if (d.strasse2) {
					ort=ort + " / " + d.strasse2;
			}

			var ut=unfalltypen[type];
			var uts="";
			if (ut) {
				if (ut.beschreibung) {
					uts=uts+"<br>Beschreibung: " + ut.beschreibung;
				}
				if (ut.ort) {
					uts=uts+"<br>Ort: " + ut.ort;
				}
				if (ut.kommentar) {
					uts=uts+"<br>Kommentar: " + ut.kommentar;
				}
			}

			var ursache=unfallursache[d.u101];

			/* Create popup with HTML code */
			var p=d.tag + " " + d.datum + " " + d.zeit + "Uhr<br>"
					+ "Ursache: " + ursache + "<br>"
					+ "<table><tr><td>" + timage + "</td><td>" + uts + "</td></tr></table><br>"
					+ ort;

			if (d.gt != 0) {
				p=p + "<br>" + d.gt + " Getötete(r)";
			}
			if (d.sv != 0) {
				p=p + "<br>" + d.sv + " Schwerletzte(r)";
			}
			if (d.lv != 0) {
				p=p + "<br>" + d.lv + " Leichtverletzte(r)";
			}

			p=p + "<br><br>Anzahl Beteiligte: " + d.bet + "<br>Hauptverursacher: " + verkehrsbeteiligter(Number(d.vb01));
			if (d.vb02) {
				p=p + "<br>Beteiligter: " + verkehrsbeteiligter(Number(d.vb02));
			}

			m.bindPopup(p)

			cluster.addLayer(m);
			marker.addLayer(m);
		}
		map.addLayer(cluster);

		L.control.layers(
					{
							"OpenStreetmap": colourlayer,
							"Greyscale": bwlayer
					},
					{
							"Cluster": cluster,
							"Marker": marker,
							"Maxspeed": maxspeed,
							"Stadtgrenze": boundary,
							"Kitas und Schulen": kita,
							"Kitas und Schulen 300m Buffer": kitabuffer
					}).addTo(map);

	</script>
</body>
</html>
